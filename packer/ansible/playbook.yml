---
- name: Install Docker
  hosts: localhost
  sudo: True
  vars:
       user_account: ubuntu
#      This must match the mount point that is used by the LVM creation task
#      mount_point: /opt/docker
       mount_point: /var/lib/docker
  tasks:
    - name: Install cURL
      apt: name=curl state=latest update_cache=true cache_valid_time=600
    - name: Download Docker Installation Script
      command: /usr/bin/curl --location --output /root/install-docker https://get.docker.com/ creates=/root/install-docker
    - name: Set Permission Bits On The Docker Installation Script
      file: path=/root/install-docker owner=root group=root mode=0500
    - name: Execute Docker Installation Script
      shell: /root/install-docker creates=/usr/bin/docker
    - name: Set Memory and Swap Accounting
      lineinfile: dest=/etc/default/grub regexp='^GRUB_CMDLINE_LINUX=""' line='GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1"'
    - name: Make some adjustments to the Docker configuration
      lineinfile: dest=/etc/default/docker line='DOCKER_OPTS="-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --storage-driver=aufs --graph={{ mount_point }}"'
    - name: Add account to the docker group 
      user: name={{ user_account }} groups=docker
    - name: Restart Docker
      command: service docker restart
    - name: Test Docker
      command: docker run hello-world
#   - name: Delete the old Docker directory so people won't get confused
#     file: path=/var/lib/docker state=absent

